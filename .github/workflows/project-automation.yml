name: Project Automation

on:
  issues:
    types: [opened, reopened, closed]
  pull_request:
    types: [opened, converted_to_draft, ready_for_review, closed]
  issue_comment:
    types: [created]
  schedule:
    - cron: '0 1 * * *'  # Daily at 1 AM UTC

jobs:
  auto-add-to-project:
    name: Add to Project Board
    runs-on: ubuntu-latest
    if: github.event.action == 'opened' || github.event.action == 'reopened'
    steps:
      - name: Add issue to project
        uses: actions/add-to-project@v0.5.0
        with:
          project-url: https://github.com/users/akaash-nigam/projects/1
          github-token: ${{ secrets.GITHUB_TOKEN }}

  auto-assign-priority:
    name: Auto-assign Priority
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'
    steps:
      - name: Add priority label based on title
        uses: actions/github-script@v7
        with:
          script: |
            const title = context.payload.issue.title.toLowerCase();
            const labels = context.payload.issue.labels.map(l => l.name);

            // Auto-assign priority based on keywords
            if (title.includes('[critical]') || title.includes('crash') || title.includes('security')) {
              if (!labels.includes('priority: critical')) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number,
                  labels: ['priority: critical']
                });
              }
            } else if (title.includes('[urgent]') || title.includes('bug') || title.includes('broken')) {
              if (!labels.includes('priority: high')) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.issue.number,
                  labels: ['priority: high']
                });
              }
            }

  link-pr-to-issue:
    name: Link PR to Issue
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'opened'
    steps:
      - name: Check PR body for issue references
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const issueNumbers = body.match(/#(\d+)/g);

            if (issueNumbers && issueNumbers.length > 0) {
              const labels = ['has-pr'];

              for (const issueRef of issueNumbers) {
                const issueNumber = parseInt(issueRef.substring(1));

                try {
                  // Add 'has-pr' label to linked issues
                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    labels: labels
                  });

                  // Add comment to issue
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: `ðŸ”— Linked to PR #${context.payload.pull_request.number}`
                  });
                } catch (error) {
                  console.log(`Could not update issue #${issueNumber}: ${error.message}`);
                }
              }
            }

  auto-close-issues:
    name: Auto-close Issues on PR Merge
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
      - name: Close linked issues
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            // Match "Fixes #123", "Closes #123", "Resolves #123"
            const fixPattern = /(?:fix|fixes|fixed|close|closes|closed|resolve|resolves|resolved)\s+#(\d+)/gi;
            const matches = [...body.matchAll(fixPattern)];

            for (const match of matches) {
              const issueNumber = parseInt(match[1]);

              try {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  state: 'closed'
                });

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `âœ… Closed by PR #${context.payload.pull_request.number}`
                });
              } catch (error) {
                console.log(`Could not close issue #${issueNumber}: ${error.message}`);
              }
            }

  stale-issue-manager:
    name: Manage Stale Issues
    runs-on: ubuntu-latest
    # Run daily at 1 AM UTC
    if: github.event_name == 'schedule'
    steps:
      - name: Mark stale issues
        uses: actions/stale@v9
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          stale-issue-message: |
            This issue has been automatically marked as stale because it has not had recent activity.
            It will be closed if no further activity occurs within 7 days.

            If this issue is still relevant, please:
            - Add a comment with updates
            - Remove the 'stale' label

            Thank you for your contributions!
          stale-pr-message: |
            This PR has been automatically marked as stale because it has not had recent activity.
            It will be closed if no further activity occurs within 7 days.

            Please rebase and resolve any conflicts if you plan to continue working on this.
          stale-issue-label: 'stale'
          stale-pr-label: 'stale'
          days-before-stale: 60
          days-before-close: 7
          exempt-issue-labels: 'pinned,security,roadmap'
          exempt-pr-labels: 'pinned,work-in-progress'
